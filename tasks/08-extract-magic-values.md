# Task 08: Extract Magic Values

## Priority: 8th (Low-Medium)

## Overview
The codebase contains numerous hardcoded values (magic numbers and strings) that should be extracted into named constants. This will improve maintainability, make the code self-documenting, and reduce the risk of errors when values need to be changed.

## Issues to Address
1. Buffer sizes and limits (64KB, 10MB)
2. Time durations (5 minutes)
3. Display thresholds (20 lines, 8 characters)
4. Entry types and role strings
5. File paths and format strings
6. Platform identifiers

## Steps to Complete

### Step 1: Create Constants Package

Create a centralized constants package:
```go
// internal/constants/constants.go
package constants

import "time"

// Buffer and size limits
const (
    // DefaultScannerBufferSize is the initial buffer size for JSONL scanner (64KB)
    DefaultScannerBufferSize = 64 * 1024
    
    // MaxJSONLLineSize is the maximum size of a single JSONL line (10MB)
    MaxJSONLLineSize = 10 * 1024 * 1024
    
    // HTMLBuilderInitialCapacity is the initial capacity for HTML string builders
    HTMLBuilderInitialCapacity = 100
)

// Time durations
const (
    // DefaultToolCallMatchWindow is the time window for matching tool calls with results
    DefaultToolCallMatchWindow = 5 * time.Minute
)

// Display thresholds
const (
    // BashOutputCollapseThreshold is the number of lines before bash output is collapsed
    BashOutputCollapseThreshold = 20
    
    // ShortUUIDLength is the number of characters to display for shortened UUIDs
    ShortUUIDLength = 8
    
    // MinTextLengthForPrefixMatch is the minimum text length for prefix matching
    MinTextLengthForPrefixMatch = 20
    
    // NumberFormattingThreshold is the minimum number to format with thousands separators
    NumberFormattingThreshold = 1000
    
    // ThousandsSeparatorInterval is the digit grouping for number formatting
    ThousandsSeparatorInterval = 3
)

// Entry types
const (
    // Entry types from JSONL logs
    EntryTypeMessage    = "message"
    EntryTypeToolCall   = "tool_call"
    EntryTypeToolResult = "tool_result"
    EntryTypeSummary    = "summary"
    
    // Message roles
    RoleUser      = "user"
    RoleAssistant = "assistant"
    RoleSystem    = "system"
    
    // Content types
    ContentTypeText       = "text"
    ContentTypeToolUse    = "tool_use"
    ContentTypeToolResult = "tool_result"
)

// Tool names
const (
    // TaskToolName is the name of the Task tool that creates sidechains
    TaskToolName = "Task"
    
    // Common tool names
    ToolNameBash      = "Bash"
    ToolNameWebSearch = "WebSearch"
    ToolNameRead      = "Read"
)

// Version information
const (
    // DefaultVersion is used when version info is not set during build
    DefaultVersion = "1.1.0"
    
    // DevelopmentVersionString indicates a development build
    DevelopmentVersionString = "(devel)"
    
    // DevVersionString is the short form for development version
    DevVersionString = "dev"
    
    // UnknownVersionString is used when version cannot be determined
    UnknownVersionString = "unknown"
)

// File formats
const (
    // TempFileTimestampFormat is the timestamp format for temporary files
    TempFileTimestampFormat = "20060102-150405"
    
    // TempFileNameFormat is the format string for temporary HTML files
    TempFileNameFormat = "cclog-%s-%s.html"
    
    // HTMLFileExtension is the file extension for HTML files
    HTMLFileExtension = ".html"
    
    // TemplateDirectoryPrefix is the prefix for template directories
    TemplateDirectoryPrefix = "templates/"
    
    // TemplateNameSeparator separates path components in template names
    TemplateNameSeparator = "/"
)

// Platform identifiers
const (
    // Platform names for OS detection
    PlatformDarwin  = "darwin"
    PlatformLinux   = "linux"
    PlatformWindows = "windows"
    
    // Platform-specific commands
    MacOSOpenCommand    = "open"
    LinuxOpenCommand    = "xdg-open"
    WindowsCommand      = "cmd"
    WindowsCmdFlag      = "/c"
    WindowsStartCommand = "start"
)

// Special strings and patterns
const (
    // CaveatMessagePrefix identifies caveat messages in logs
    CaveatMessagePrefix = "Caveat: The messages below were generated by the user while running local commands."
    
    // UserInterruptionPattern identifies interrupted requests
    UserInterruptionPattern = "request interrupted by user"
    
    // Command XML tags
    CommandNameOpenTag  = "<command-name>"
    CommandNameCloseTag = "</command-name>"
    CommandNameTag      = "command-name"
    CommandArgsTag      = "command-args"
    LocalCommandStdoutTag = "local-command-stdout"
)

// Token estimation
const (
    // EnglishTokenToWordRatio is the approximate ratio of tokens to words
    EnglishTokenToWordRatio = 1.3
)

// Matching scores
const (
    // PerfectMatchScore indicates a perfect sidechain match
    PerfectMatchScore = 2
)

// Processing configuration
const (
    // LineNumberStartIndex is the starting line number for diffs
    LineNumberStartIndex = 1
    
    // RootConversationDepth is the depth of root-level entries
    RootConversationDepth = 1
)
```

### Step 2: Update Parser Package

**File**: `internal/parser/jsonl.go`

```go
import (
    "github.com/brads3290/cclogviewer/internal/constants"
)

func ReadJSONLFile(filename string) ([]models.LogEntry, error) {
    // Before:
    // buf := make([]byte, 0, 64*1024)
    // scanner.Buffer(buf, 10*1024*1024)
    
    // After:
    buf := make([]byte, 0, constants.DefaultScannerBufferSize)
    scanner.Buffer(buf, constants.MaxJSONLLineSize)
    
    // Before:
    // if entry.Type == "summary" {
    
    // After:
    if entry.Type == constants.EntryTypeSummary {
        continue
    }
}
```

### Step 3: Update Processor Package

**File**: `internal/processor/entries.go`

```go
import "github.com/brads3290/cclogviewer/internal/constants"

func processEntry(state *ProcessingState, entry *models.ProcessedEntry) {
    // Before:
    // if strings.HasPrefix(entry.Content, "Caveat: The messages below...")
    
    // After:
    if strings.HasPrefix(entry.Content, constants.CaveatMessagePrefix) {
        entry.IsCaveatMessage = true
    }
    
    // Update XML tag parsing
    commandStart := strings.Index(entry.Content, constants.CommandNameOpenTag)
    commandEnd := strings.Index(entry.Content, constants.CommandNameCloseTag)
}

// Update role checks
if entry.Role == constants.RoleAssistant {
    // Process assistant message
}
```

**File**: `internal/processor/matcher.go`

```go
func NewToolCallMatcher() *ToolCallMatcher {
    return &ToolCallMatcher{
        window: constants.DefaultToolCallMatchWindow,
    }
}

// Update interruption check
if strings.Contains(content, constants.UserInterruptionPattern) {
    toolCall.WasInterrupted = true
}
```

### Step 4: Update Renderer Package

**File**: `internal/renderer/html.go`

```go
"shortUUID": func(uuid string) string {
    if len(uuid) > constants.ShortUUIDLength {
        return uuid[:constants.ShortUUIDLength]
    }
    return uuid
},

// Update bash output collapse logic
if len(lines) > constants.BashOutputCollapseThreshold {
    // Create collapsible section
}

// Update number formatting
func formatNumber(n int) string {
    if n < constants.NumberFormattingThreshold {
        return fmt.Sprintf("%d", n)
    }
    // Format with thousands separators
}
```

### Step 5: Update Browser Package

**File**: `internal/browser/browser.go`

```go
func OpenInBrowser(filename string) error {
    var cmd *exec.Cmd
    switch runtime.GOOS {
    case constants.PlatformDarwin:
        cmd = exec.Command(constants.MacOSOpenCommand, filename)
    case constants.PlatformLinux:
        cmd = exec.Command(constants.LinuxOpenCommand, filename)
    case constants.PlatformWindows:
        cmd = exec.Command(constants.WindowsCommand, 
            constants.WindowsCmdFlag, 
            constants.WindowsStartCommand, 
            filename)
    default:
        return fmt.Errorf("unsupported platform: %s", runtime.GOOS)
    }
    return cmd.Start()
}
```

### Step 6: Update Main Package

**File**: `cmd/cclogviewer/main.go`

```go
var version = constants.DefaultVersion

func getVersion() string {
    if version == constants.UnknownVersionString {
        return constants.UnknownVersionString
    }
    if strings.Contains(version, constants.DevelopmentVersionString) {
        return constants.DevVersionString
    }
    return version
}

// Update temp file creation
timestamp := time.Now().Format(constants.TempFileTimestampFormat)
outputFile = filepath.Join(os.TempDir(), 
    fmt.Sprintf(constants.TempFileNameFormat, baseName, timestamp))
```

### Step 7: Update Tool Formatters

Update all tool formatters to use constants:
```go
// internal/processor/sidechain.go
if toolCall.Name == constants.TaskToolName {
    // Process Task tool
}

// Matching logic
if !promptMatch && len(taskPromptNorm) > constants.MinTextLengthForPrefixMatch {
    // Perform prefix matching
}

if score == constants.PerfectMatchScore {
    return sidechain, score
}
```

### Step 8: Add Configuration Support

Create a configuration structure for values that might need to be configurable:
```go
// internal/config/config.go
package config

import "time"

// ProcessingConfig holds configurable processing parameters
type ProcessingConfig struct {
    // Buffer sizes
    ScannerBufferSize int
    MaxLineSize       int
    
    // Time windows
    ToolCallMatchWindow time.Duration
    
    // Display options
    BashCollapseThreshold int
    ShortUUIDLength      int
    
    // Feature flags
    EnableDebugLogging bool
}

// DefaultConfig returns the default configuration
func DefaultConfig() *ProcessingConfig {
    return &ProcessingConfig{
        ScannerBufferSize:     constants.DefaultScannerBufferSize,
        MaxLineSize:          constants.MaxJSONLLineSize,
        ToolCallMatchWindow:  constants.DefaultToolCallMatchWindow,
        BashCollapseThreshold: constants.BashOutputCollapseThreshold,
        ShortUUIDLength:      constants.ShortUUIDLength,
        EnableDebugLogging:   false,
    }
}
```

### Step 9: Document Constants

Add comprehensive documentation for each constant:
```go
// DefaultToolCallMatchWindow defines how long after a tool call we look for
// its result. This accounts for network latency and processing time while
// preventing false matches in long conversations.
const DefaultToolCallMatchWindow = 5 * time.Minute
```

## Testing Requirements

1. Verify all magic values have been replaced
2. Run full test suite to ensure no behavior changes
3. Check that constants are used consistently

## Success Criteria
- [ ] All magic values extracted to constants package
- [ ] Constants are well-documented
- [ ] No hardcoded values remain in code
- [ ] Configuration support for values that might change
- [ ] All tests pass with no behavior changes
- [ ] Code is more readable and self-documenting

## Verification Steps

1. Search for remaining magic values:
```bash
# Search for hardcoded numbers
grep -r "[0-9]\+" --include="*.go" | grep -v "constants.go"

# Search for hardcoded strings
grep -r '"[a-zA-Z_-]\+"' --include="*.go" | grep -v "constants.go"
```

2. Review each constant usage
3. Ensure no duplicate definitions

## Notes
- Some values might be better as configuration options
- Group related constants together
- Use descriptive names that explain the purpose
- Consider using iota for related constants
- Don't over-extract - some inline values are fine