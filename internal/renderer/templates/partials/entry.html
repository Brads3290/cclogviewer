{{define "entry"}}
{{if or (ne .Content "") .ToolCalls}}{{/* Render if content is not empty OR has tool calls */}}
<div class="entry {{.Type}} depth-{{mod (sub .Depth 1) 5 | add 1}}{{if .IsSidechain}} sidechain{{end}}" 
     data-debug-id="entry-{{shortUUID .UUID}}"
     data-uuid="{{.UUID}}"
     data-parent-uuid="{{.ParentUUID}}"
     data-is-sidechain="{{.IsSidechain}}"
     data-depth="{{.Depth}}"
     data-color-depth="{{mod (sub .Depth 1) 5 | add 1}}">
    <div class="entry-header">
        {{if .IsSidechain}}
            {{if eq .Role "user"}}
            <span class="role assistant">Prompt</span>
            {{else if eq .Role "assistant"}}
            <span class="role subagent">Sub Agent</span>
            {{end}}
        {{else}}
            <span class="role {{.Role}}">{{.Role}}</span>
        {{end}}
        <span class="timestamp">{{.Timestamp}}</span>
        {{if .IsSidechain}}
        <span style="color: #9c27b0; font-size: 0.85em;">ðŸ“Ž Task</span>
        {{end}}
        {{if eq .Role "assistant"}}
        <span class="token-toggle">
            {{if .TotalTokens}}Conversation size: {{formatNumber .TotalTokens}} | {{end}}
            <span class="token-expand-icon">[+]</span>
            <span class="token-details">
                {{if or .InputTokens .OutputTokens .CacheReadTokens .CacheCreationTokens}}
                    {{if .InputTokens}}{{formatNumber .InputTokens}} input{{end}}
                    {{if and .InputTokens (or .OutputTokens .CacheReadTokens .CacheCreationTokens)}} | {{end}}
                    {{if .OutputTokens}}~{{formatNumber .OutputTokens}} output{{end}}
                    {{if and .OutputTokens (or .CacheReadTokens .CacheCreationTokens)}} | {{end}}
                    {{if .CacheReadTokens}}{{formatNumber .CacheReadTokens}} cache read{{end}}
                    {{if and .CacheReadTokens .CacheCreationTokens}} | {{end}}
                    {{if .CacheCreationTokens}}{{formatNumber .CacheCreationTokens}} cache write{{end}}
                {{else if .TokenCount}}
                    ~{{formatNumber .TokenCount}} tokens
                {{end}}
            </span>
        </span>
        {{else if eq .Role "user"}}
        <span style="color: #666; font-size: 0.85em;">
            {{if .OutputTokens}}~{{formatNumber .OutputTokens}} tokens{{end}}
        </span>
        {{end}}
    </div>
    
    {{if .IsCaveatMessage}}
    <div class="caveat-message">
        <div class="caveat-header" style="cursor: pointer; user-select: none; display: flex; align-items: center; gap: 5px; color: #999; font-style: italic;">
            <svg class="caveat-expand-icon" width="16" height="16" viewBox="0 0 20 20" fill="currentColor" style="transition: transform 0.2s;">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
            </svg>
            <span>Command caveat message</span>
        </div>
        <div class="caveat-content" style="display: none; margin-top: 10px;">
            <div class="content">{{formatContent .Content}}</div>
        </div>
    </div>
    {{else if .IsCommandMessage}}
    <div class="command-message">
        <div style="color: #999; font-style: italic;">
            {{.CommandName}}{{if .CommandArgs}} {{.CommandArgs}}{{end}}
        </div>
        {{if .CommandOutput}}
        <div style="margin-top: 5px; color: #666;">
            {{formatContent .CommandOutput}}
        </div>
        {{end}}
    </div>
    {{else if eq .Content ""}}
    {{/* Hide entries with empty content (stdout messages that were linked to commands) */}}
    {{else}}
    <div class="content">{{formatContent .Content}}</div>
    {{end}}
    
    {{if .ToolCalls}}
    <div class="tool-calls">
        {{range .ToolCalls}}
            {{template "tool-call" .}}
        {{end}}
    </div>
    {{end}}
    
</div>
{{end}}{{/* End of content check */}}
{{end}}